# Workflow Efficiency Audit

**Date:** 2025-12-18
**Scope:** Claude API tokens, GitHub Actions, pre-commit hooks, build/test configuration
**Methodology:** Current configuration analysis (no historical data)

---

## Executive Summary

This audit identifies inefficiencies in the Rackula development workflow that contribute to excessive resource consumption, particularly Claude API tokens and CI/CD execution time. The primary consumers are:

1. **Pre-commit hooks running full test suite** - blocks every commit with 279 tests
2. **Type-aware ESLint on every commit** - slow `projectService: true` parsing
3. **Duplicate npm installations in CI** - `npm ci` runs twice per deployment
4. **Missing Docker layer caching** - full rebuilds on every tag push

Implementing the Priority 1 recommendations alone could reduce commit-time overhead by 60-80% and Claude session token usage by 30-40%.

---

## Part A: Resource Consumption Analysis

### Consumption Hierarchy (Highest to Lowest Impact)

| Rank | Consumer                 | Resource Type          | Impact     | Location              |
| ---- | ------------------------ | ---------------------- | ---------- | --------------------- |
| 1    | Pre-commit test suite    | Time + Claude tokens   | **HIGH**   | `.husky/pre-commit`   |
| 2    | ESLint projectService    | Time (blocking)        | **HIGH**   | `eslint.config.js:43` |
| 3    | Dual npm ci in CI        | GitHub Actions minutes | **MEDIUM** | `deploy-dev.yml`      |
| 4    | Docker builds (no cache) | Build time             | **MEDIUM** | `docker.yml`          |
| 5    | Husky v9 deprecation     | Future breakage        | **MEDIUM** | `.husky/_/husky.sh`   |
| 6    | jsdom test environment   | Test execution time    | **LOW**    | `vitest.config.ts:15` |
| 7    | Redundant docker pull    | Minor waste            | **LOW**    | `deploy-vps.yml`      |

---

### 1. Pre-commit Hooks (HIGH Impact)

**Current Configuration:** `.husky/pre-commit`

```bash
npx lint-staged
npm run test:run -- --passWithNoTests
```

**Problem:**

- Runs ALL 279 tests on every commit, regardless of what files changed
- Blocks developer flow, encouraging `--no-verify` bypass
- When Claude Code makes commits, this consumes tokens waiting for test completion
- Tests also run in CI, making pre-commit tests redundant for correctness

**Token Impact:**

- Each commit triggers ~15-30 seconds of test output
- Claude sessions parsing this output consume tokens on status updates
- Developers bypassing hooks means CI catches issues later (more back-and-forth)

**Metrics:**

- Test suite execution: ~8-15 seconds
- ESLint + Prettier: ~3-5 seconds
- Total commit blocking time: ~15-25 seconds per commit

---

### 2. ESLint Type-Aware Checking (HIGH Impact)

**Current Configuration:** `eslint.config.js:43`

```javascript
parserOptions: {
  projectService: true,
  extraFileExtensions: ['.svelte']
}
```

**Problem:**

- `projectService: true` enables full TypeScript type checking during ESLint
- Parses entire project type graph for every linted file
- Adds 2-5x overhead compared to syntax-only linting
- Runs on every commit via lint-staged

**Token Impact:**

- Longer lint times = longer Claude wait times
- Type errors surface in lint output, consuming output tokens

---

### 3. GitHub Actions - Dual npm ci (MEDIUM Impact)

**Current Configuration:** `.github/workflows/deploy-dev.yml`

```yaml
jobs:
  check:
    steps:
      - uses: actions/setup-node@v4
        with:
          cache: 'npm'
      - run: npm ci # First install
      - run: npm run lint
      - run: npm run test:run

  build:
    needs: check
    steps:
      - uses: actions/setup-node@v4
        with:
          cache: 'npm'
      - run: npm ci # Second install (redundant)
      - run: npm run build
```

**Problem:**

- `npm ci` runs in both `check` and `build` jobs
- Each `npm ci` downloads and installs 171MB of node_modules
- Cache only helps with download, not extraction/install time
- Jobs run on separate runners, cannot share installed modules

**GitHub Actions Impact:**

- ~30-60 seconds wasted per deployment
- Billable minutes accumulate over time

---

### 4. Docker Builds Without Layer Caching (MEDIUM Impact)

**Current Configuration:** `.github/workflows/docker.yml`

```yaml
- uses: docker/build-push-action@v6
  with:
    context: .
    push: true
    tags: ${{ steps.meta.outputs.tags }}
    # No cache-from or cache-to specified
```

**Problem:**

- Every tag push rebuilds entire Docker image from scratch
- No layer caching between builds
- `npm install` in Dockerfile runs fresh every time

**Build Time Impact:**

- Full builds: 2-4 minutes
- With caching: 30-60 seconds (for dependency-only changes)

---

### 5. Husky v9 Deprecation Warning (MEDIUM Impact)

**Current Configuration:** `.husky/_/husky.sh`

```bash
# husky.sh shows deprecation notice
# Hooks WILL FAIL in husky v10.0.0
```

**Problem:**

- Currently on husky v9.1.7
- v10.0.0 will break current hook configuration
- Requires migration before upgrade

**Risk:**

- Future `npm update` could break all pre-commit hooks silently

---

### 6. Vitest jsdom Environment (LOW Impact)

**Current Configuration:** `vitest.config.ts:15`

```typescript
environment: 'jsdom';
```

**Problem:**

- jsdom is slower than happy-dom alternative
- 10-20% test execution overhead
- 279 tests means cumulative impact

**Note:** jsdom provides more complete DOM implementation, may be required for some tests.

---

### 7. Redundant Docker Pull (LOW Impact)

**Current Configuration:** `.github/workflows/deploy-vps.yml`

```yaml
steps:
  - run: docker pull ghcr.io/Rackula/Rackula:latest
  - run: docker compose pull && docker compose up -d --remove-orphans
```

**Problem:**

- First `docker pull` is redundant
- `docker compose pull` will pull the same image

---

## Part B: Implementation-Ready Recommendations

### Priority 1: Quick Wins (< 30 min each)

#### 1.1 Remove Tests from Pre-commit Hook

**File:** `.husky/pre-commit`

**Before:**

```bash
npx lint-staged
npm run test:run -- --passWithNoTests
```

**After:**

```bash
npx lint-staged
```

**Rationale:**

- Tests run in CI anyway (deploy-dev.yml)
- Pre-commit should be fast (< 5 seconds)
- Developers can run tests manually before pushing

**Impact:** 60-80% reduction in commit time

---

#### 1.2 Disable Type-Aware ESLint for Pre-commit

**Option A: Create fast lint config for pre-commit**

**File:** `eslint.config.fast.js` (new file)

```javascript
import js from '@eslint/js';
import prettier from 'eslint-config-prettier';
import svelte from 'eslint-plugin-svelte';

export default [
	js.configs.recommended,
	...svelte.configs['flat/recommended'],
	prettier,
	{
		ignores: ['build/', '.svelte-kit/', 'dist/', 'node_modules/', 'coverage/']
	}
];
```

**File:** `package.json` (modify lint-staged)

```json
"lint-staged": {
  "*.{js,ts,svelte}": [
    "eslint --config eslint.config.fast.js --fix",
    "prettier --write"
  ],
  "*.{json,md,css,html}": [
    "prettier --write"
  ]
}
```

**Option B: Skip ESLint in pre-commit entirely**

**File:** `package.json`

```json
"lint-staged": {
  "*.{js,ts,svelte,json,md,css,html}": [
    "prettier --write"
  ]
}
```

**Rationale:** Full ESLint runs in CI; pre-commit only needs formatting.

**Impact:** 50-70% reduction in lint time

---

#### 1.3 Remove Redundant Docker Pull

**File:** `.github/workflows/deploy-vps.yml`

**Before:**

```yaml
steps:
  - run: docker pull ghcr.io/Rackula/Rackula:latest
  - run: docker compose pull && docker compose up -d --remove-orphans
  - run: docker image prune -af
```

**After:**

```yaml
steps:
  - run: docker compose pull && docker compose up -d --remove-orphans
  - run: docker image prune -af
```

**Impact:** Minor time savings, cleaner workflow

---

### Priority 2: Medium Effort (1-2 hours)

#### 2.1 Add Docker Layer Caching

**File:** `.github/workflows/docker.yml`

**Before:**

```yaml
- uses: docker/build-push-action@v6
  with:
    context: .
    push: true
    tags: ${{ steps.meta.outputs.tags }}
```

**After:**

```yaml
- uses: docker/build-push-action@v6
  with:
    context: .
    push: true
    tags: ${{ steps.meta.outputs.tags }}
    cache-from: type=gha
    cache-to: type=gha,mode=max
```

**Impact:** 50-80% faster Docker builds for dependency-unchanged releases

---

#### 2.2 Share node_modules Between CI Jobs

**File:** `.github/workflows/deploy-dev.yml`

**Option A: Use artifacts (simple)**

```yaml
jobs:
  check:
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run test:run
      - uses: actions/upload-artifact@v4
        with:
          name: node-modules
          path: node_modules
          retention-days: 1

  build:
    needs: check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/download-artifact@v4
        with:
          name: node-modules
          path: node_modules
      - run: npm run build
```

**Option B: Single job with stages (simpler)**

```yaml
jobs:
  build-and-deploy:
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run test:run
      - run: npm run build
        env:
          VITE_ENV: development
      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist
```

**Impact:** 30-60 seconds saved per deployment

---

#### 2.3 Upgrade Husky Before v10 Breaking Change

**Commands:**

```bash
# Check current version
npm ls husky

# Update to latest v9.x
npm update husky

# Or prepare for v10 migration (when released)
# See: https://typicode.github.io/husky/migrate-from-v9-to-v10.html
```

**File:** `.husky/pre-commit` (v10 format, when available)

```bash
#!/bin/sh
# v10 removes the sourcing requirement
npx lint-staged
```

**Impact:** Prevents future CI breakage

---

### Priority 3: Larger Improvements (half-day+)

#### 3.1 Switch Test Environment to happy-dom

**File:** `vitest.config.ts`

**Before:**

```typescript
environment: 'jsdom';
```

**After:**

```typescript
environment: 'happy-dom';
```

**Additional step:**

```bash
npm install -D happy-dom
npm uninstall jsdom  # if no longer needed
```

**Caveat:** Test compatibility check required. Some DOM APIs may behave differently.

**Impact:** 10-20% faster test execution

---

#### 3.2 Implement Affected-Tests-Only Pre-commit (Optional)

If tests must run on commit, use Vitest's related files feature:

**File:** `.husky/pre-commit`

```bash
npx lint-staged

# Only run tests related to changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|svelte)$' | tr '\n' ' ')
if [ -n "$CHANGED_FILES" ]; then
  npx vitest related $CHANGED_FILES --run --passWithNoTests
fi
```

**Impact:** Tests only affected code, 70-90% faster for small changes

---

#### 3.3 Claude Code Session Optimization

**File:** `.claude/settings.local.json`

The current settings grant extensive permissions which is good for autonomous operation, but consider:

1. **Reduce verbose output parsing:**
   - Tests produce large output that Claude parses
   - Consider `--reporter=dot` for terser test output in hooks

2. **Memory plugin considerations:**
   - `claude-mem` stores observations, consuming tokens on retrieval
   - Use targeted searches rather than broad `get_recent_context` calls

3. **dev-issue command optimization:**
   - The 700+ line command file is loaded per invocation
   - Consider splitting into smaller focused commands

---

## Appendix: Current Configuration Reference

### File Inventory

| File                                       | Purpose                     | Last Modified |
| ------------------------------------------ | --------------------------- | ------------- |
| `.husky/pre-commit`                        | Pre-commit hook             | Current       |
| `package.json`                             | Scripts, lint-staged config | Current       |
| `eslint.config.js`                         | ESLint configuration        | Current       |
| `vitest.config.ts`                         | Test configuration          | Current       |
| `.github/workflows/deploy-dev.yml`         | Dev deployment              | Current       |
| `.github/workflows/docker.yml`             | Docker build                | Current       |
| `.github/workflows/deploy-vps.yml`         | Production deployment       | Current       |
| `.github/workflows/release.yml`            | Release creation            | Current       |
| `.github/workflows/project-automation.yml` | Issue automation            | Current       |
| `.claude/settings.local.json`              | Claude permissions          | Current       |
| `.claude/commands/dev-issue.md`            | Autonomous workflow         | Current       |

### Dependency Sizes

| Package              | Size  | Notes                   |
| -------------------- | ----- | ----------------------- |
| node_modules (total) | 171MB | Full dev environment    |
| jsdom                | 2.7MB | Test DOM implementation |
| vite                 | 1.3MB | Build tool              |
| vitest               | 1.1MB | Test runner             |
| @testing-library/\*  | 0.8MB | Test utilities          |
| eslint + plugins     | 2.2MB | Linting                 |

### Test Suite Statistics

| Metric                 | Value                        |
| ---------------------- | ---------------------------- |
| Total test files       | 279                          |
| Test environment       | jsdom                        |
| Coverage threshold     | 75% statements, 70% branches |
| Typical execution time | 8-15 seconds                 |

---

## Implementation Checklist

### Immediate (Today) - COMPLETED

- [x] Remove `npm run test:run` from `.husky/pre-commit` _(done in #76)_
- [x] Remove redundant `docker pull` from `deploy-vps.yml` _(done in #76)_
- [x] Simplify lint-staged to Prettier-only _(done in #76)_

### This Week - COMPLETED

- [x] Add Docker layer caching to `docker.yml` _(done in #77)_
- [x] Consolidate CI jobs (eliminated dual npm ci) _(done in #77)_
- [x] Suppress debug logging during tests _(done in #77)_

### Priority 3 - COMPLETED (#78)

- [x] Add affected-tests-only pre-commit with `vitest related`
- [x] Add `--reporter=dot` for terse test output
- [x] Review dev-issue.md - already has good memory guidance (lines 50-65)

### Future (Low Priority)

- [ ] Evaluate happy-dom migration _(#79)_

### Husky v10 Migration (When Released)

**Current status:** Husky v9.1.7 with deprecation warning in `.husky/_/husky.sh`

**Migration steps when v10 is stable:**

1. Check release notes at https://typicode.github.io/husky/
2. Update: `npm update husky`
3. Remove `.husky/_/` directory (no longer needed in v10)
4. Update hook files to remove `#!/usr/bin/env sh` and `. "$(dirname -- "$0")/_/husky.sh"` lines
5. Test pre-commit hook still works

**No action needed now** - wait for v10 stable release.

---

_Generated by Claude Code workflow audit - 2025-12-18_
_Updated: 2025-12-18 (Issues #76, #77, #78 completed)_
